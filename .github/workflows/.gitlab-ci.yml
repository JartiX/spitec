name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  stop_app:
    name: Stop Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Stop application if running
        run: |
          if [ -f "/tmp/gunicorn.pid" ]; then
            echo "Found existing PID file, stopping application..."
            kill -9 $(cat /tmp/gunicorn.pid) || true
            rm /tmp/gunicorn.pid
          else
            echo "No running application found."
          fi

  install_deps:
    name: Install Dependencies
    runs-on: ubuntu-latest
    needs: stop_app
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install dependencies via Poetry
        run: poetry install

  start_app:
    name: Start Application
    runs-on: ubuntu-latest
    needs: install_deps
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Create logging directory if not exists
        run: |
          if [ ! -d "./logging" ]; then
            mkdir logging
          fi
      - name: Start application via Gunicorn
        run: |
          nohup poetry run gunicorn -w 4 -b 0.0.0.0:8050 --pid /tmp/gunicorn.pid main:server > ./logging/log.txt 2>&1 &
          COUNTER=0
          while [ ! -f /tmp/gunicorn.pid ]; do
            if [ $COUNTER -ge 15 ]; then
              echo "PID file not created within timeout. Exiting with failure."
              exit 1
            fi
            sleep 1
            COUNTER=$((COUNTER+1))
          done
          echo "Application started successfully."
          sleep 10
      - name: Upload log artifact
        uses: actions/upload-artifact@v3
        with:
          name: application-log
          path: ./logging/log.txt
